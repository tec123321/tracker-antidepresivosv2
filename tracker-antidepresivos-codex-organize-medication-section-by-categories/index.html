<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Seguimiento de medicación</title>
  <link rel="stylesheet" href="styles.css" />
<style>
/* --- Estilos adicionales para el plan simple integrado --- */
.card-simple-plan {
  margin-top: 2rem;
}

.simple-plan-grid {
  display: grid;
  grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
  gap: 1.5rem;
  margin-bottom: 1.5rem;
}

.simple-plan-col h3 {
  margin-top: 0;
}

.simple-summary {
  width: 100%;
  min-height: 9rem;
  resize: vertical;
}

.simple-plan-calendar {
  margin-top: 0.5rem;
}

.simple-calendar-wrapper table {
  min-width: 480px;
}

.small-hint {
  font-size: 0.8rem;
  color: #64748b;
  margin-top: 0.5rem;
}

.btn-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 1rem;
}

.btn-row-tight {
  margin-top: 0.6rem;
}

@media (max-width: 900px) {
  .simple-plan-grid {
    grid-template-columns: minmax(0, 1fr);
  }
}
</style></head>
<body>
  <header class="hero">
    <div class="hero__top">
      <div class="brand">
        <div class="brand__mark" aria-hidden="true"></div>
        <div class="brand__text">
          <span class="brand__name">NeuroTrack</span>
          <span class="brand__tagline">Registro personal de medicación</span>
        </div>
      </div>
      <span class="hero__badge">Tus datos se guardan solo en este navegador</span>
    </div>
    <div class="hero__grid">
      <div>
        <p class="eyebrow">Salud mental</p>
        <h1>Registro semanal de medicación</h1>
        <p class="lede">Organiza tu tratamiento, registra progresos y recibe recordatorios adaptados a tu ritmo.</p>
        <div class="actions">
          <button id="scrollToForm" class="primary">Añadir medicación</button>
          <button id="scrollToReminders" class="ghost">Ver recordatorios</button>
          <a class="ghost link-button" href="interacciones.html">Interacciones</a>
          <a class="ghost link-button" href="retiro.html">Plan de retiro</a>
        </div>
      </div>
      <div class="pill-card">
        <p class="pill-card__title">Resumen rápido</p>
        <div class="pill-card__stat" id="statActive">0 planes activos</div>
        <div class="pill-card__stat" id="statDue">0 recordatorios pendientes</div>
        <div class="pill-card__stat" id="statWeek">Semana 0 en curso</div>
      </div>
    </div>
  </header>

  <main>
    <section class="panel" id="alerts">
      <div class="panel__header">
        <div class="panel__title">
          <div class="panel__icon panel__icon--alerts" aria-hidden="true"></div>
          <div>
            <p class="eyebrow">Alertas de interacción</p>
          <h2>Notas para tu próxima cita</h2>
          </div>
        </div>
        <p class="muted">Interacciones simuladas con un catálogo de ejemplo; sirven como guías para conversar con tu médico.</p>
      </div>
      <div id="alertCard" class="alert-card alert-card--empty">
        <p class="muted">Aún no hay alertas. Añade medicamentos o suplementos para ver recomendaciones.</p>
      </div>
    </section>

    <section class="panel" id="catalog">
      <div class="panel__header">
        <div class="panel__title">
          <div class="panel__icon panel__icon--catalog" aria-hidden="true"></div>
          <div>
            <p class="eyebrow">Catálogo base</p>
          <h2>Medicamentos por categoría</h2>
          </div>
        </div>
        <p class="muted">Solo se muestran medicamentos aquí. Los suplementos se listan aparte para no mezclar indicaciones.</p>
      </div>
      <div class="catalog-grid">
        <div>
          <p class="pill-card__title">Antidepresivos y ansiolíticos</p>
          <div id="medCatalog" class="chip-grid"></div>
        </div>
        <div>
          <p class="pill-card__title">Suplementos y hábitos</p>
          <div id="suppCatalog" class="chip-grid"></div>
        </div>
      </div>
      <div class="muted" style="margin-top:12px;">Consulta las interacciones completas en la página de <a class="text-link" href="interacciones.html">interacciones</a>.</div>
    </section>

    <section class="panel" id="reminders">
      <div class="panel__header">
        <div class="panel__title">
          <div class="panel__icon panel__icon--reminders" aria-hidden="true"></div>
          <div>
            <p class="eyebrow">Recordatorios semanales</p>
          <h2>Que no se te pase registrar</h2>
          </div>
        </div>
        <p class="muted">Los recordatorios se basan en tus intervalos personalizados y muestran cuándo fue tu último registro.</p>
      </div>
      <div id="reminderList" class="reminder-grid"></div>
    </section>

    <section class="panel" id="add">
      <div class="panel__header">
        <div class="panel__title">
          <div class="panel__icon panel__icon--add" aria-hidden="true"></div>
          <div>
            <p class="eyebrow">Nuevo tratamiento</p>
          <h2>Configura tu plan</h2>
          </div>
        </div>
        <p class="muted">Define cada medicamento, su dosis, la frecuencia de recordatorio y la duración estimada.</p>
      </div>
      <form id="medForm" class="form-grid" autocomplete="off">
        <label>Nombre del medicamento<input list="medOptions" required name="name" placeholder="Ej. Sertralina" autocomplete="off" autocapitalize="none" spellcheck="false" /></label>
        <datalist id="medOptions"></datalist>
        <label>Dosis y horario<input required name="dose" placeholder="50 mg por la mañana" /></label>
        <label>Fecha de inicio<input required name="start" type="date" /></label>
        <label>Duración objetivo (semanas)<input required name="duration" type="number" min="1" max="52" value="12" /></label>
        <label>Recordar cada (semanas)<input required name="interval" type="number" min="1" max="6" value="1" /></label>
        <label>Notas iniciales<textarea name="notes" rows="2" placeholder="Indicaciones o expectativas"></textarea></label>
        <button class="primary" type="submit">Guardar plan</button>
      </form>
    </section>

    <section class="panel">
  <div class="panel__header">
    <div class="panel__title">
      <div class="panel__icon panel__icon--progress" aria-hidden="true"></div>
      <div>
        <p class="eyebrow">Seguimiento</p>
        <h2>Tu progreso por medicamento</h2>
      </div>
    </div>
    <p class="muted">
      Añade registros semanales con síntomas, efectos secundarios y notas personalizadas.
      Usa el buscador y los filtros para centrarte en lo que necesitas hoy.
    </p>
  </div>

  <div class="toolbar">
    <div class="toolbar__group">
      <label class="field-inline">
        <span class="sr-only">Buscar medicamento</span>
        <input
          id="medSearch"
          type="search"
          placeholder="Buscar por nombre, dosis o notas…"
          autocomplete="off"
        />
      </label>
    </div>
    <div class="toolbar__group">
      <label class="field-inline">
        <span class="sr-only">Filtrar por estado</span>
        <select id="medFilterStatus">
          <option value="all">Todos los estados</option>
          <option value="due">Con registro pendiente</option>
          <option value="snoozed">En pausa</option>
          <option value="ok">Al día</option>
          <option value="noLogs">Sin registros aún</option>
        </select>
      </label>
    </div>
  </div>

  <div class="timeline-legend" aria-hidden="true">
    <span class="timeline-legend__item">
      <span class="legend-dot legend-dot--done"></span> Semana registrada
    </span>
    <span class="timeline-legend__item">
      <span class="legend-dot legend-dot--pending"></span> Semana pendiente
    </span>
    <span class="timeline-legend__item">
      <span class="legend-dot legend-dot--future"></span> Próximas semanas
    </span>
  </div>

  <div id="medList" class="med-grid"></div>
</section>
  
    <!-- PLAN SIMPLE: configuración básica + calendario + resumen para la cita -->
    <section class="card card-simple-plan">
      <header class="section-header">
        <h2>Plan simple de medicación (vista calendario)</h2>
        <p class="section-subtitle">
          Usa esta vista rápida para generar un pequeño calendario de tomas y un resumen
          de tu plan actual para llevar a tu cita.
        </p>
      </header>

      <div class="simple-plan-grid">
        <div class="simple-plan-col">
          <h3 class="section-subtitle">Configuración básica</h3>
          <div class="form-row">
            <div class="field">
              <label for="simplePatientName">Nombre del paciente (opcional)</label>
              <input type="text" id="simplePatientName" placeholder="Ej: Ana P." autocomplete="off"/>
            </div>
          </div>
          <div class="form-row">
            <div class="field">
              <label for="simpleStartDate">Fecha de inicio del plan</label>
              <input type="date" id="simpleStartDate"/>
            </div>
            <div class="field">
              <label for="simpleDays">Días a mostrar</label>
              <select id="simpleDays">
                <option value="7">7 días</option>
                <option value="14" selected>14 días</option>
                <option value="30">30 días</option>
              </select>
            </div>
          </div>

          <div class="btn-row">
            <button type="button" id="simpleGenerate" class="btn primary">Actualizar calendario y resumen</button>
            <button type="button" id="simpleSave" class="btn secondary">Guardar plan en este dispositivo</button>
            <button type="button" id="simpleClear" class="btn ghost">Borrar plan guardado</button>
          </div>

          <p class="small-hint">
            Todo se guarda solo en este navegador (localStorage). Si borras los datos de navegación
            o cambias de dispositivo, tendrás que volver a introducir el plan.
          </p>
        </div>

        <div class="simple-plan-col">
          <h3 class="section-subtitle">Resumen para la cita médica</h3>
          <textarea id="simpleSummary" class="simple-summary" readonly spellcheck="false"></textarea>
          <div class="btn-row btn-row-tight">
            <button type="button" id="simpleCopySummary" class="btn secondary">Copiar resumen</button>
          </div>
        </div>
      </div>

      <div class="simple-plan-calendar">
        <h3 class="section-subtitle">Calendario de tomas (vista rápida)</h3>
        <div class="table-wrapper simple-calendar-wrapper">
          <table id="simpleCalendarTable">
            <thead>
              <tr>
                <th>Día</th>
                <th>Tomas programadas</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="small-hint">
          Este calendario solo reparte las tomas por día según la duración y las veces/día que tengas
          configuradas en la tabla principal de medicación. Los horarios exactos se definen siempre con tu médico.
        </p>
      </div>
    </section>
</main>

  <template id="progressFormTemplate">
    <div class="progress-form">
      <label>Estado de ánimo (1-5)
        <input name="mood" type="range" min="1" max="5" value="3" />
        <div class="range-labels"><span>Muy bajo</span><span>Neutral</span><span>Óptimo</span></div>
      </label>
      <label>Efectos secundarios
        <input name="effects" placeholder="Náuseas, insomnio..." />
      </label>
      <label>Notas
        <textarea name="notes" rows="2" placeholder="Cambios percibidos, ajustes, etc." ></textarea>
      </label>
      <label class="checkbox">
        <input type="checkbox" name="adherence" /> Tomé todas las dosis esta semana
      </label>
      <label>Extender recordatorio (semanas)
        <input name="snooze" type="number" min="0" max="6" value="0" />
      </label>
      <div class="form-actions">
        <button class="primary" type="submit">Guardar registro</button>
        <button class="ghost" type="button" data-close>Cancelar</button>
      </div>
    </div>
  </template>
<script src="adherencia.js"></script>
  <script type="module" src="script.js"></script>

  <script>
    (function () {
      const STORAGE_KEY_SIMPLE = "medTrackerSimplePlan_v1";

      function qs(sel) { return document.querySelector(sel); }
      function qsa(sel) { return Array.from(document.querySelectorAll(sel)); }

      const patientInput = qs("#simplePatientName");
      const startDateInput = qs("#simpleStartDate");
      const daysSelect = qs("#simpleDays");
      const summaryTextarea = qs("#simpleSummary");
      const calendarBody = qs("#simpleCalendarTable tbody");

      const btnGenerate = qs("#simpleGenerate");
      const btnSave = qs("#simpleSave");
      const btnClear = qs("#simpleClear");
      const btnCopySummary = qs("#simpleCopySummary");

      if (!btnGenerate || !calendarBody) return; // por si se reutiliza el HTML sin esta sección

      function setTodayByDefault() {
        if (!startDateInput) return;
        if (startDateInput.value) return;
        try {
          const today = new Date();
          const iso = today.toISOString().slice(0, 10);
          startDateInput.value = iso;
        } catch (e) {}
      }

      function readMedsFromMainTable() {
        const rows = qsa("#medCatalog table tbody tr, #medTable tbody tr, #medicationTable tbody tr");
        // Intentamos detectar la tabla; si tu HTML usa otra id, actualiza el selector de arriba.
        if (!rows.length) return [];

        return rows.map(function (tr) {
          const nameEl = tr.querySelector("[data-field=\"name\"], .med-name, td:nth-child(1) input, td:nth-child(1) span");
          const doseEl = tr.querySelector("[data-field=\"dose\"], .med-dose, td:nth-child(2) input, td:nth-child(2) span");
          const freqEl = tr.querySelector("[data-field=\"frequency\"], .med-times, td:nth-child(3) input, td:nth-child(3) span");
          const durEl = tr.querySelector("[data-field=\"duration\"], .med-duration, td:nth-child(4) input, td:nth-child(4) span");
          const notesEl = tr.querySelector("[data-field=\"notes\"], .med-notes, td:nth-child(5) input, td:nth-child(5) span");

          function val(el) {
            if (!el) return "";
            if ("value" in el) return (el.value || "").trim();
            return (el.textContent || "").trim();
          }

          const times = parseInt(val(freqEl), 10);
          const dur = parseInt(val(durEl), 10);

          return {
            name: val(nameEl),
            dose: val(doseEl),
            timesPerDay: Number.isFinite(times) ? times : null,
            durationDays: Number.isFinite(dur) ? dur : null,
            notes: val(notesEl)
          };
        }).filter(function (m) {
          return m.name || m.dose || m.timesPerDay || m.durationDays || m.notes;
        });
      }

      function buildCalendar(meds, startDateStr, daysToShow) {
        calendarBody.innerHTML = "";
        if (!meds.length || !startDateStr || !Number.isFinite(daysToShow)) return;

        let startDate;
        try {
          startDate = new Date(startDateStr + "T00:00:00");
          if (Number.isNaN(startDate.getTime())) return;
        } catch (e) {
          return;
        }

        for (let offset = 0; offset < daysToShow; offset++) {
          const date = new Date(startDate);
          date.setDate(date.getDate() + offset);

          const yyyy = date.getFullYear();
          const mm = String(date.getMonth() + 1).padStart(2, "0");
          const dd = String(date.getDate()).padStart(2, "0");
          const label = dd + "/" + mm + "/" + yyyy;

          const medsForDay = meds.filter(function (m) {
            if (!Number.isFinite(m.durationDays) || m.durationDays <= 0) return false;
            return offset < m.durationDays;
          });

          if (!medsForDay.length) continue;

          const tr = document.createElement("tr");
          const itemsHtml = medsForDay.map(function (m) {
            const freqTxt = m.timesPerDay ? m.timesPerDay + "×/día" : "frecuencia sin definir";
            const doseTxt = m.dose ? " — " + m.dose : "";
            return "<li><strong>" + (m.name || "Medicamento") + "</strong>: " + freqTxt + doseTxt + "</li>";
          }).join("");

          tr.innerHTML = "<td class=\"date-cell\">" + label + "</td>" +
                         "<td><ul class=\"compact-list\">" + itemsHtml + "</ul></td>";
          calendarBody.appendChild(tr);
        }
      }

      function buildSummary(meds, patient, startDateStr) {
        if (!meds.length) {
          summaryTextarea.value = "";
          return;
        }
        const lines = [];

        if (patient) {
          lines.push("Paciente: " + patient);
        } else {
          lines.push("Paciente: (no indicado)");
        }

        if (startDateStr) {
          lines.push("Inicio del plan: " + startDateStr);
        }

        lines.push("");
        lines.push("Esquema de medicación actual:");
        meds.forEach(function (m) {
          const name = m.name || "Medicamento sin nombre";
          const dose = m.dose || "dosis sin especificar";
          const freq = (m.timesPerDay != null)
            ? m.timesPerDay + " vez/veces al día"
            : "frecuencia sin definir";
          const dur = (m.durationDays != null)
            ? m.durationDays + " días"
            : "duración sin definir";
          let base = "• " + name + ": " + dose + " — " + freq + " — " + dur;
          if (m.notes) base += ". Notas: " + m.notes;
          lines.push(base);
        });

        lines.push("");
        lines.push("Notas para la cita médica (para revisar juntos):");
        lines.push("- Confirmar si las dosis y horarios actuales son adecuados.");
        lines.push("- Revisar posibles interacciones y contraindicaciones.");
        lines.push("- Ajustar duración total del tratamiento si corresponde.");
        lines.push("- Definir horarios exactos de cada toma (mañana/tarde/noche).");
        lines.push("");
        lines.push("Este texto lo generé con una herramienta personal de organización. No sustituye la valoración de un profesional de la salud.");

        summaryTextarea.value = lines.join("\n");
      }

      function saveSimplePlan(meds) {
        try {
          const payload = {
            patient: patientInput ? patientInput.value.trim() : null,
            startDate: startDateInput ? startDateInput.value : null,
            daysToShow: daysSelect ? parseInt(daysSelect.value, 10) || 14 : 14,
            meds: meds
          };
          localStorage.setItem(STORAGE_KEY_SIMPLE, JSON.stringify(payload));
        } catch (e) {}
      }

      function loadSimplePlan() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY_SIMPLE);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (e) {
          return null;
        }
      }

      function applyLoadedPlan(plan) {
        if (!plan || typeof plan !== "object") return;
        if (patientInput && plan.patient) patientInput.value = plan.patient;
        if (startDateInput && plan.startDate) startDateInput.value = plan.startDate;
        if (daysSelect && plan.daysToShow) daysSelect.value = String(plan.daysToShow);
      }

      function clearSimplePlan() {
        try {
          localStorage.removeItem(STORAGE_KEY_SIMPLE);
        } catch (e) {}
      }

      function refresh() {
        const meds = readMedsFromMainTable();
        const patient = patientInput ? patientInput.value.trim() : "";
        const startDateStr = startDateInput ? startDateInput.value : "";
        const daysToShow = daysSelect ? parseInt(daysSelect.value, 10) || 14 : 14;
        buildCalendar(meds, startDateStr, daysToShow);
        buildSummary(meds, patient, startDateStr);
        return meds;
      }

      btnGenerate.addEventListener("click", function () {
        refresh();
      });

      if (btnSave) {
        btnSave.addEventListener("click", function () {
          const meds = refresh();
          saveSimplePlan(meds);
          alert("Plan simple guardado en este dispositivo.");
        });
      }

      if (btnClear) {
        btnClear.addEventListener("click", function () {
          clearSimplePlan();
          if (patientInput) patientInput.value = "";
          if (summaryTextarea) summaryTextarea.value = "";
          calendarBody.innerHTML = "";
          setTodayByDefault();
          alert("Plan simple borrado. Puedes configurarlo de nuevo cuando quieras.");
        });
      }

      if (btnCopySummary) {
        btnCopySummary.addEventListener("click", async function () {
          if (!summaryTextarea || !summaryTextarea.value.trim()) return;
          try {
            await navigator.clipboard.writeText(summaryTextarea.value);
            alert("Resumen copiado al portapapeles.");
          } catch (e) {
            alert("No se pudo copiar de forma automática. Copia el texto manualmente.");
          }
        });
      }

      // Inicialización
      setTodayByDefault();
      const loaded = loadSimplePlan();
      applyLoadedPlan(loaded);
      refresh();
    })();
  </script>
</body>
</html>
